language: go

go:
  - 1.13

services:
  - docker

env:
  - GO111MODULE=on

install: true

stages:
  - test
  - build

jobs:
  include:
    - stage: test
      script: go test --bench --benchmem -v
    - stage: build
      if: tag IS present
      env: 
        - IMAGE_NAME=docker.pkg.github.com/titansoft-pte-ltd/imagepullsecret-patcher/release
      script: 
        - docker login -u $GITHUB_USER -p $GITHUB_TOKEN docker.pkg.github.com
        - docker build -t $IMAGE_NAME .
        - docker push $IMAGE_NAME 
        - docker tag $IMAGE_NAME $IMAGE_NAME:$TRAVIS_BRANCH
        - docker push $IMAGE_NAME:$TRAVIS_BRANCH
