language: go

go:
  - 1.13

services:
  - docker

env:
  - GO111MODULE=on

install: true

stages:
  - test
  - build

jobs:
  include:
    - stage: test
      name: Test and Benchmark
      script: go test --bench --benchmem -v
    - stage: test
      name: Codecov Report
      script: go test -race -coverprofile=coverage.txt -covermode=atomic
      after_success: bash <(curl -s https://codecov.io/bash)
    - stage: build
      name: Quay.io
      if: tag IS present
      env: 
        - IMAGE_NAME=quay.io/titansoft/imagepullsecret-patcher
      script: 
        - docker login -u $QUAY_IO_ACCOUNT -p $QUAY_IO_TOKEN quay.io
        - docker build -t $IMAGE_NAME:$TRAVIS_TAG .
        - docker push $IMAGE_NAME:$TRAVIS_TAG
